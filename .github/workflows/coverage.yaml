name: Coverage Badge

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync

      - name: Run tests with coverage
        run: |
          uv run pytest --cov=src --cov-report=json

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(python -c "import json; print(round(json.load(open('coverage.json'))['totals']['percent_covered']))")
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

      - name: Create coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: 38d0496076c1af1acd30ccdeb07e8417
          filename: coverage-badge.json
          label: coverage
          message: ${{ env.COVERAGE }}%
          color: ${{ env.COVERAGE > 90 && 'brightgreen' || env.COVERAGE > 70 && 'green' || env.COVERAGE > 50 && 'yellow' || 'red' }}
